
# Make classes out of each data set
```{r}

library(latex2exp)
library(patchwork)
library(here)
require(plyr)
require(data.table)
require(tidyverse)
library(devtools)
# Required for this analysis
require(reshape2)
require(foreach)
require(doParallel)
require(bayesplot)
require(coda)
require(ggplot2)
require(viridis)
require(ggpubr)
library(mvoutlier)

require(foreach)
require(doParallel)
require(Rcpp)

require(extrafont)
require(showtext)
font_add("Avenir", "/Users/davidhodgson/Documents/personal/fonts/avenir_ff/AvenirLTStd-Book.otf")  
showtext_auto()
theme_set(theme_light())
library(wesanderson)

```

# Load packages and data
Currently using the serosolver 
```{r}

#install_github("https://github.com/dchodge/serosolver", ref = "custom_ab")
#install("/Users/davidhodgson/Documents/research/flu/serosolver_vac")
#install(here::here("rcppfunchcw"))

devtools::load_all()
require(serosolver)
require(rcppfunchcw)
 
load(here::here("data", "hcwpre_data.RDS")) # hcwpre

get_model_info_hcw_pre_cross(hcwpre)
get_model_info_hcw_pre_full(hcwpre)


````

# Fitting is done in a separate R script
```{r}

load(file = here::here("data", paste0("modelinfo_cross_", hcwpre$study_name_short, ".RDS"))) #all_models_hcw_pre_cross

setup_run_serosolver(
    all_models_hcw_pre_cross[[4]],
    chains = 4,
    iterations = 20000,
    pt = TRUE,
    filename = "dis_dep",
    cross_sectional = TRUE,
    continue_run = FALSE)

1:9 %>% map(~setup_run_serosolver(
    all_models_hcw_pre_cross[[.x]],
    chains = 4,
    pt = TRUE,
    filename = "dis_dep",
    cross_sectional = TRUE,
    continue_run = FALSE)
)

```


```{r}

load(file = here::here("data", paste0("modelinfo_full_", hcwpre$study_name_short, ".RDS"))) #all_models_hcw_pre_full
1:4 %>% map(~setup_run_serosolver(
    all_models_hcw_pre_full[[.x]],
    chains = 4,
    pt = TRUE,
    filename = "dis_dep",
    cross_sectional = FALSE,
    continue_run = FALSE)
)

```

# Load the mcmc and plot the traces and schematics of titre loss
```{r}

load(file = here::here("data", paste0("modelinfo_cross_", hcwpre$study_name_short, ".RDS"))) #all_models_hcw_pre_cross
all_models_hcw_pre_cross <- all_models_hcw_pre
all_post_test_cross <- all_models_hcw_pre_cross %>%
    map(~load_mcmc_post(.x,
        fit_place = "local",
        folder_name_1 = "dis_dep",
        cross_sectional = TRUE,
        burnin = 0,
        thin = 1))

purrr::map2(all_post_test_cross, all_models_hcw_pre_cross, ~plot_traces(.x, .y, file = "dis_dep/cross_sec"))
purrr::map2(all_post_test_cross, all_models_hcw_pre_cross, ~plot_histogram(.x, .y, file = "dis_dep/cross_sec"))
purrr::map2(all_post_test_cross, all_models_hcw_pre_cross, ~plot_titre_post(.x, .y, file = "dis_dep/cross_sec"))

```

```{r}

load(file = here::here("data", paste0("modelinfo_full_", hcwpre$study_name_short, ".RDS"))) #all_models_hcw_pre_full
all_post_test_full <- all_models_hcw_pre_full %>%
    map(~load_mcmc_post(.x,
        fit_place = "local",
        folder_name_1 = "dis_dep",
        cross_sectional = FALSE,
        burnin = 0,
        thin = 1))

purrr::map2(all_post_test_full, all_models_hcw_pre_full, ~plot_traces(.x, .y, file = "dis_dep/full"))
purrr::map2(all_post_test_full, all_models_hcw_pre_full, ~plot_titre_post(.x, .y, file = "dis_dep/full"))

```

```{r}

average <- all_post_test[[2]]$theta_chain[2200:4404, c("mu", "mu_vac", "mu_short_vac", "wane_vac")] %>% apply(2, mean)
c(average[["mu"]] * average[["mu_vac"]], average[["mu"]] * average[["mu_vac"]] + (average[["mu_short_vac"]] - ((1:11) * average[["wane_vac"]])))


```

# Comparison figures and statistics in sum_figs folder

```{r}

# Trim the the data, use last 50% and throw out outliers 
all_post_test_cross_trim <- vector(mode = "list", length = 9)
samp_no_list <- vector(mode = "list", length = 9)
for (p in 1:9) { 
    L <- nrow(all_post_test_cross[[p]]$theta_list_chain[[1]])
    B <- round(L / 2)
    chain_list <- all_post_test_cross[[p]]$theta_list_chain
    pars_plot <- setdiff(all_models_hcw_pre_cross[[p]]$other$pars_plot, "tau_vac" )
    all_post_test_cross_trim[[p]] <- chain_list %>% map(~(.x[B:L, pars_plot] %>% as.data.frame))
    samp_no_list[[p]] <- chain_list %>% map(~.x[B:L, c("sampno")])

    #trimmed_post_list <- chain_list %>% map(~.x[B:L, all_models_hcw_pre_cross[[p]]$other$pars_plot])

   # bool_vec_list <- trimmed_post_list %>% map(~aq.plot(.x,
    #        delta = qchisq(0.975, df = ncol(trimmed_post_list[[1]])), quan = 1, alpha = 0.01)[[1]])
   # all_post_test_cross_trim[[p]] <- 1:4 %>% map(~as.data.frame(trimmed_post_list[[.x]][!bool_vec_list[[.x]], ]))
}

# Plots box plots of the 8 different models
plot_post_compare(all_post_test_cross_trim, all_models_hcw_pre_cross, file = "dis_dep/cross_sec")

# Plots the mpsrf for the models to check convergences
mpsrf_df <- purrr::map2(all_post_test_cross_trim[2:9], all_models_hcw_pre_cross[2:9], ~calc_mpsrf(.x, .y)) %>% bind_rows
save_plot_mpsrf(mpsrf_df, all_models_hcw_pre_cross[[1]], file = "dis_dep/cross_sec")

# Plots the waics for the models and compare, TAKES AGES

waics <- purrr::pmap(list(all_post_test_cross, samp_no_list, all_models_hcw_pre_cross), ~calc_waic(..1, ..2, ..3))
save_plot_waic(waics[2:9], file = "dis_dep/cross_sec")


```