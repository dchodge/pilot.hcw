
# Make classes out of each data set
```{r}

library(latex2exp)
library(patchwork)
library(here)
require(plyr)
require(data.table)
require(tidyverse)
library(devtools)
library(loo)
# Required for this analysis
require(reshape2)
require(foreach)
require(doParallel)
require(bayesplot)
require(coda)
require(ggplot2)
require(viridis)
require(ggpubr)
library(mvoutlier)

require(foreach)
require(doParallel)
require(Rcpp)

require(extrafont)
require(showtext)
font_add("Avenir", "/Users/davidhodgson/Documents/personal/fonts/avenir_ff/AvenirLTStd-Book.otf")  
showtext_auto()
theme_set(theme_light())
library(wesanderson)

```

# Load packages and data
Currently using the serosolver 
```{r}


#install_github("https://github.com/dchodge/serosolver", ref = "custom_ab")
#install("/Users/davidhodgson/Documents/research/flu/serosolver_vac")
#install(here::here("rcppfunchcw"))

devtools::load_all()
require(serosolver)
require(rcppfunchcw)
 
load(here::here("data", "hanam_data.RDS")) # hcwpre

get_model_info_hanam(hanam)

````

# install new custom_ab functions
```{r}


```

# Fitting is done in a separate R script
```{r}


load(file = here::here("data", paste0("modelinfo_cross_", hanam$study_name_short, ".RDS"))) #all_models_hcw_pre_cross
setup_run_serosolver(
    all_models_hanam_cross[[1]],
    chains = 4,
    iterations = 1000000,
    pt = TRUE,
    filename = "dis_dep",
    cross_sectional = TRUE,
    continue_run = FALSE)
)

setup_run_serosolver(
    all_models_hanam_cross[[2]],
    chains = 4,
    iterations = 1000000,
    pt = TRUE,
    filename = "dis_dep",
    cross_sectional = FALSE,
    continue_run = FALSE)
)

#load(file = here::here("data", paste0("modelinfo_full_", hcwpre$study_name_short, ".RDS"))) #all_models_hcw_pre_full
#5 %>% map(~setup_run_serosolver(
#    all_models_hcw_pre_full[[.x]],
#    chains = 4,
#    iterations = 1000000,
##    pt = TRUE,
#    filename = "dis_dep",
#    cross_sectional = FALSE,
#    continue_run = FALSE)
#)

```


# Load the mcmc and plot the traces and schematics of titre loss
```{r}

load(file = here::here("data", paste0("modelinfo_cross_", hanam$study_name_short, ".RDS"))) #all_models_hcw_pre_cross

    
all_post_test_cross_hanam <- load_mcmc_post(all_models_hanam_cross[[1]],
    fit_place = "local",
    folder_name_1 = "dis_dep",
    cross_sectional = TRUE,
    burnin = 0,
    thin = 1)

all_post_test_cross_trim_hanam <- vector(mode = "list", length = 1)
samp_no_list <- vector(mode = "list", length = 1)
for (p in 1:1) { 
    L <- nrow(all_post_test_cross_hanam$theta_list_chain[[1]])
    B <- round(L / 2)
    chain_list <- all_post_test_cross_hanam$theta_list_chain
    pars_plot <- setdiff(all_models_hanam_cross[[1]]$other$pars_plot, "tau_vac" )
    all_post_test_cross_trim_hanam[[p]] <- chain_list %>% map(~(.x[B:L, pars_plot] %>% as.data.frame))
    samp_no_list[[p]] <- chain_list %>% map(~.x[B:L, c("sampno")])
}

all_post_test_cross_trim_inf_hist_hanam <- vector(mode = "list", length = 1)
samp_no_list <- vector(mode = "list", length = 1)
for (p in 1:1) { 
    L <- nrow(all_post_test_cross_hanam$inf_list_chains[[1]])
    B <- round(L / 2)
    inf_hist <- all_post_test_cross_hanam$inf_list_chains
    all_post_test_cross_trim_inf_hist_hanam[[p]] <- inf_hist %>%
        map(~(.x %>% filter(sampno == 1200001) %>% as.data.frame %>%
        rename(yr = i, id = j)))
}

post_cross <- list(post_raw = all_post_test_cross_hanam, post_trim = all_post_test_cross_trim_hanam, inf_hist_trim = all_post_test_cross_trim_inf_hist_hanam)
save(post_cross, file = here::here("outputs", "hanam", "fits", "dis_dep", "cross_sec", "trimmed_post_cross.Rdata"))

```


# Comparison figures and statistics in sum_figs folder

```{r}

plot_traces(all_post_test_cross_hanam, all_models_hanam_cross[[1]], file = "dis_dep/cross_sec")
plot_histogram(all_post_test_cross_hanam, all_models_hanam_cross[[1]], file = "dis_dep/cross_sec")
plot_titre_post(all_post_test_cross_hanam, all_models_hanam_cross[[1]], file = "dis_dep/cross_sec")


```



# Load the mcmc and plot the traces and schematics of titre loss
```{r}

load(file = here::here("data", paste0("modelinfo_cross_", hanam$study_name_short, ".RDS"))) #all_models_hcw_pre_cross

all_post_test_cross_hanam <- load_mcmc_post(
    all_models_hanam_cross[[2]],
    fit_place = "local",
    folder_name_1 = "dis_dep",
    cross_sectional = FALSE,
    burnin = 0,
    thin = 1)

all_post_test_cross_trim_hanam <- vector(mode = "list", length = 1)
samp_no_list <- vector(mode = "list", length = 1)
for (p in 1:1) { 
    L <- nrow(all_post_test_cross_hanam$theta_list_chain[[1]])
    B <- round(L / 2)
    chain_list <- all_post_test_cross_hanam$theta_list_chain
    pars_plot <- setdiff(all_models_hanam_cross[[1]]$other$pars_plot, "tau_vac" )
    all_post_test_cross_trim_hanam[[p]] <- chain_list %>% map(~(.x[B:L, pars_plot] %>% as.data.frame))
    samp_no_list[[p]] <- chain_list %>% map(~.x[B:L, c("sampno")])
}

all_post_test_cross_trim_inf_hist_hanam <- vector(mode = "list", length = 1)
samp_no_list <- vector(mode = "list", length = 1)
for (p in 1:1) { 
    L <- nrow(all_post_test_cross_hanam$inf_list_chains[[1]])
    B <- round(L / 2)
    inf_hist <- all_post_test_cross_hanam$inf_list_chains
    all_post_test_cross_trim_inf_hist_hanam[[p]] <- inf_hist %>%
        map(~(.x %>% filter(sampno == 1200001) %>% as.data.frame %>%
        rename(yr = i, id = j)))
}

post_cross <- list(post_raw = all_post_test_cross_hanam, post_trim = all_post_test_cross_trim_hanam, inf_hist_trim = all_post_test_cross_trim_inf_hist_hanam)
save(post_cross, file = here::here("outputs", "hanam", "fits", "dis_dep", "full", "trimmed_post_full.Rdata"))

```


# Comparison figures and statistics in sum_figs folder

```{r}

plot_traces(all_post_test_cross_hanam, all_models_hanam_cross[[2]], file = "dis_dep/full")
plot_histogram(all_post_test_cross_hanam, all_models_hanam_cross[[2]], file = "dis_dep/full")
plot_titre_post(all_post_test_cross_hanam, all_models_hanam_cross[[2]], file = "dis_dep/full")

```


# Get the priors for the full version

```{r}

# Best fit model is mt according to waic
post_best <- all_post_test_cross_trim[[3]] %>% bind_rows
post_best %>% apply(2, median) %>% as.data.frame %>% t
post_best %>% apply(2, quantile, c(0.01, 0.99)) %>% as.data.frame

```
